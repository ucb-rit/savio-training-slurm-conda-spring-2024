<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title>Conda/Mamba</title>
  <style type="text/css">
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
    href="https://www.w3.org/Talks/Tools/Slidy2/styles/slidy.css" />
  <script src="https://www.w3.org/Talks/Tools/Slidy2/scripts/slidy.js"
    charset="utf-8" type="text/javascript"></script>
</head>
<body>
<div class="slide titlepage">
  <h1 class="title">Conda/Mamba</h1>
</div>
<div id="what-is-conda" class="slide section level1">
<h1>What is Conda?</h1>
<ul>
<li>Conda is an open source package and environment management
system</li>
<li>If you are installing it on your local machine you can pick between
Miniconda and Anaconda</li>
<li>Conda can manage packages for a wide variety of programming
languages but is most often used with python</li>
<li>works well across multiple platforms (macOS, Windows, Linux)</li>
</ul>
</div>
<div id="what-are-conda-environments" class="slide section level1">
<h1>What are Conda Environments?</h1>
<ul>
<li>Conda environments are isolated spaces created within Conda that
allow users to use and manage different versions of Python and
packages</li>
<li>Each environment can have its own set of packages without affecting
other environments</li>
<li>Environemnts ensure reproducibility of code and help avoid conflicts
between package versions</li>
</ul>
<center>
<img src="conda_illustration.png">
</center>
<p>(Image from
https://nbisweden.github.io/excelerate-scRNAseq/conda_instructions.html)</p>
</div>
<div id="conda-vs-mamba" class="slide section level1">
<h1>Conda Vs Mamba</h1>
<ul>
<li>Conda may be slow at times</li>
<li>Mamba is a faster drop in replacement for conda which is implemented
in c++ and takes advantage of parallel loading</li>
<li>Mamba and Conda can be used interchangably just change the prefix
conda to mamba for each command</li>
</ul>
<p>Mamba can be installed like such, remember you may need to install it
again inside your conda environment as conda environments are blank
slates</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install mamba <span class="at">-c</span> conda-forge</span></code></pre></div>
<p>Note: as Savio upgrades to the Rocky8 operating system(in the coming
months) mamba can be set as the default solver in conda by doing the
following in your base environment:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> conda install <span class="at">-n</span> base conda-libmamba-solver</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> conda config <span class="at">--set</span> solver libmamba</span></code></pre></div>
</div>
<div id="why-should-we-use-them" class="slide section level1">
<h1>Why Should We Use Them?</h1>
<ul>
<li>Dependency Management
<ul>
<li>manage project specifiic dependencies without affecting other
projects on the system</li>
</ul></li>
<li>Reproducibility
<ul>
<li>scientific computing, Jupyter Kernels</li>
</ul></li>
<li>Collaboration
<ul>
<li>share environments with others, easy to export, everyone works with
same packages</li>
</ul></li>
<li>Cross-Platform
<ul>
<li>environments work the same way across operating systems</li>
</ul></li>
</ul>
</div>
<div id="setting-and-creating-environments"
class="slide section level1">
<h1>Setting and Creating Environments</h1>
<ul>
<li>In Savio a Conda Environment can be set up like such:
<ul>
<li>we can specify packages to add at time of creation by including them
to the right of our command ie. <code>numpy</code></li>
<li>we can set our version of python ie. <code>python=3.10</code> doing
so isolates the environment’s python from your system’s base python
installation</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load python</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">--name</span><span class="op">=</span>test_env python=3.10 numpy</span></code></pre></div>
<p>We can do the same thing using mamba</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">-c</span> conda-forge <span class="at">--name</span> test_env2 python=3.10</span></code></pre></div>
<p>Afterwards we can view all of our environments and where they are
located with the following command:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env list</span></code></pre></div>
<p>the output may look something like this, the environment we are in
currently will be marked by a *</p>
<pre><code># conda environments:
#
base                  *  /Users/yourusername/anaconda3
myenv                    /Users/yourusername/anaconda3/envs/myenv
another-env              /Users/yourusername/anaconda3/envs/another-env</code></pre>
</div>
<div id="conda-channels" class="slide section level1">
<h1>Conda Channels</h1>
<p>Why did we include <code>-c conda-forge</code> in our command?</p>
<ul>
<li>Conda Channels are the locations where the actual packages are
stored common channels include
<ul>
<li>Anaconda: the deafult channel, it hosts a large number of packages
and is considered stable</li>
<li>conda-forge: A Community driven channel that has a larger number of
packages than anaconda and often has newer versions</li>
<li>nvidia: This channel is specifically for packages optimized for
NVIDIA hardware, like GPU-accelerated libraries.</li>
</ul></li>
<li>It is generally a good idea to opt for the conda-forge channel for
more up to date packages and a broader selection</li>
</ul>
<p>conda-forge can be set as the priority channel like such:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> config <span class="at">--add</span> channels conda-forge</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> config <span class="at">--set</span> channel_priority strict</span></code></pre></div>
</div>
<div id="activating-adding-to-and-deleting-environments"
class="slide section level1">
<h1>Activating, Adding to, and Deleting Environments</h1>
<ul>
<li><p>Environments can be activated using <code>source activate</code>
or <code>conda/mamba activate</code></p></li>
<li><p><code>source</code> is <a
href="https://docs-research-it.berkeley.edu/services/high-performance-computing/user-guide/software/using-software/using-python-savio/">recomended
on Savio</a> as using conda activate might require the use of
<code>conda init</code> which can alter ther shell behavior due to
odifiying .bashrc conda may now attempt to start a base environment when
logging into the shell causing slowdowns.</p></li>
<li><p>If you do use conda init you can stop base environment setup with
the following:</p></li>
</ul>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>  <span class="ex">conda</span> config <span class="at">--set</span> auto_activate_base False</span></code></pre></div>
<p>Let’s activate our environemnt</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> activate test_env</span></code></pre></div>
<p>To add to an environment we use the install command while in a
environment, we can also set the verion of our package</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> install <span class="at">-c</span> conda-forge scipy=1.4.1</span></code></pre></div>
<p>We can also install packages in conda environments through pip, this
is generally not recomended if there is a corresponding conda
installation availible as pip and conda may resolve dependancies
differently. If we do install via pip in a environment the installation
will be confined to the environment, avoiding impacts on the global
<code>~/.local directory</code>.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install pandas</span></code></pre></div>
<p>To exit the environment:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> deactivate</span></code></pre></div>
<p>Finally we can delete our environment if we no longer need it</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> remove <span class="at">--name</span> test_env <span class="at">--all</span></span></code></pre></div>
</div>
<div id="creating-and-using-export-files" class="slide section level1">
<h1>Creating and Using Export Files</h1>
<ul>
<li>Part of the reason Conda is so popular is the ability to share
environments with anyone, streamlining the development process</li>
<li>the actual export file is written in <code>yaml</code> and dictates
how the environment should be set up, here is an example of what one may
look like:</li>
</ul>
<div class="sourceCode" id="cb14"><pre
class="sourceCode yml"><code class="sourceCode yaml"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> myenv</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">channels</span><span class="kw">:</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> conda-forge</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> defaults</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> numpy=1.18.1</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> pandas=1.0.3</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> python=3.8</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">pip</span><span class="kw">:</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> pandas</span></span></code></pre></div>
<p>You can generate one of these based on your current environment
configuration as follows, make sure you are in a env:</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env export <span class="op">&gt;</span> environment.yml</span></code></pre></div>
<p>You can create a conda env based on a configuration file like
such:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> env create <span class="at">-f</span> environment.yml</span></code></pre></div>
</div>
<div id="deleting-unused-packages-and-saving-environments-to-scratch"
class="slide section level1">
<h1>Deleting Unused Packages and Saving Environments to Scratch</h1>
<ul>
<li>Up to now all of our environments have been saved to our local
directory in the <code>.conda</code> folder. On Savio we are granted 10
gb of storage space on local, this can quickly fill up esspecially when
working with larger packages.</li>
<li><code>~/.conda/pkgs</code> Directory: This subdirectory within
~/.conda stores package caches. Whenever you install a package using
Conda, it downloads these packages as compressed files and stores them
here before extracting them into the specified environment. Keeping
these files allows Conda to avoid downloading them again if you need to
reinstall a package.</li>
<li>Deleting a conda env thus does not actually delete the associated
packages, it is best practice to occasionally clean
<code>.conda/pkgs</code> for this reason to save disk spack and maximize
performance.</li>
</ul>
<p>To view all cached packages:</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> list <span class="at">--cache</span></span></code></pre></div>
<p>To delete unused packages:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> clean <span class="at">--packages</span></span></code></pre></div>
<p>to delete all cached packages:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> clean <span class="at">--all</span></span></code></pre></div>
<ul>
<li>Of course this is oftetimes not feasible as there are no unused
packages and you do not want to delete anything. Saving conda
environments to the scratch directory is a great way to circumvent the
10gb storage limit on local.</li>
</ul>
<p>This can be done as such</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">--prefix</span> /global/scratch/users/jejacob/conda/scratch_myenv python=3.8 numpy pandas</span></code></pre></div>
<p>This environment can be activated from anywhere on Savio like
such:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> activate /global/scratch/users/jejacob/conda/scratch_myenv </span></code></pre></div>
</div>
<div id="using-our-environment-as-a-jupyter-kernel"
class="slide section level1">
<h1>Using our environment as a Jupyter Kernel</h1>
<ul>
<li>Another popular reason to use conda is its great integration with
Jupyter Notebooks</li>
<li>Jupyter notebooks are very popular on Savio and can be accsessed
through <a
href="https://docs-research-it.berkeley.edu/services/high-performance-computing/user-guide/ood/jupyter/">Open
on Demand</a></li>
</ul>
<p>To add a conda env as a Jupyter Kernel you can do the following, make
sure <code>Jupyter</code> and <code>Ipykernel</code> are installed on
the environment</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> activate myenv</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> install jupyter ipykernel</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> ipykernel install <span class="at">--user</span> <span class="at">--name</span><span class="op">=</span>myenv <span class="at">--display-name</span><span class="op">=</span><span class="st">&quot;Python (myenv)&quot;</span></span></code></pre></div>
<p>To view all your kernels:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">jupyter</span> kernelspec list</span></code></pre></div>
<p>And to remove one:</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">jupyter</span> kernelspec remove <span class="op">&lt;</span>kernel-name<span class="op">&gt;</span></span></code></pre></div>
</div>
<div id="using-condamamba-for-non-python-related-software"
class="slide section level1">
<h1>Using Conda/Mamba for non-Python related software</h1>
<ul>
<li>Like with Python packages, Mamba and Conda can create isolated
environments for other languages and tools, ensuring that different
projects with varying dependencies do not interfere with each
other.</li>
<li>They can manage packages for R, Ruby, Lua, Scala, Java, JavaScript,
C++, Fortran, and more. This includes support for managing system
libraries and binaries.</li>
<li>Both utilize the Anaconda repository and Conda-forge, a
community-driven collection of repositories that significantly expand
the number and types of packages available.</li>
</ul>
<p>An R example:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">--name</span> my-r-env r-essentials r-base</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> activate my-r-env</span></code></pre></div>
<p>C++ example:</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> create <span class="at">--name</span> cpp-env</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> activate cpp-env</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> install <span class="at">-c</span> conda-forge boost</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> install <span class="at">-c</span> conda-forge cmake</span></code></pre></div>
</div>
</body>
</html>
